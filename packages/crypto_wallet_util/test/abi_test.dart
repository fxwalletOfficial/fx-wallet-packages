import 'package:test/test.dart';

import 'package:crypto_wallet_util/src/transaction/eth/lib/eth_lib.dart';

void main() {
  final expectedFunctionName = 'swapExactAmountIn';
  final expectedFunctionSignature =
      'swapExactAmountIn(address,(address,address,uint256,uint256,uint256,bytes32,address),uint256,bytes,bytes)';

  const exampleData =
      '0xe3ead59e00000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee452000000000000000000000000000000000000000000000000017e7c331884c000000000000000000000000000000000000000000000000000013b9230a19971d5000000000000000000000000000000000000000000000000013d2826958c10a3956759cbb6c74411b8481488f0cf2d6a00000000000000000000000001fe461d0000000000000000000000000000000000000000000000000000000000000000de219fe970acbc88c63c9c4d0705837c6701495f90000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000007e0000000000000000000000000000007800000000000000000000000000000271042000000000000000000000000000000000000060000002000040000ff00000900000000000000000000000000000000000000000000000000000000d0e30db000000000000000000000000000000000000000000000072006c40624000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000001c0000000000000000000000000000020d042000000000000000000000000000000000000060000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb000000000000000000000000744d441ed6a00d59ea1e3fdbad2b10d9a869c92f0000000000000000000000000000000000000000000000000141499b8f79c000744d441ed6a00d59ea1e3fdbad2b10d9a869c92f000001200024000020000003000000000000000000000000000000000000000000000000000000003eece7db0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000141499b8f79c00000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040c00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000004c000000000000001200000000000000640aee2b8d4a154e36f479daece3fb3e6c3c03d396e00000140008400ef0000000b00000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000000000000000000000000000000000006890239e000000000000000000000000000000000000000000000000003d3297890b00000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b42000000000000000000000000000000000000060001f42416092f143378750bb29b79ed961ab195cceea500000000000000000000000000000000000000000085a80afee867adf27b50bdb7b76da70f1e853062000002c001040244ff00000b00000000000000000000000000000000000000000000000000000000286f580d0000000000000000000000000000000000000000000000000000000000000080ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000002416092f143378750bb29b79ed961ab195cceea50000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000003a47db6cf8ebde00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000f8f10f39116716e89498c1c5e94137ada11b2bc7000000000000000000000000f8f10f39116716e89498c1c5e94137ada11b2bc70000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b5bfb5adb736ea852bd58fec71db3b356c2a39380000000000000000000000000830820d1a9aa1554364752d6d8f55c836871b7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000830820d1a9aa1554364752d6d8f55c836871b74000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee45200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee4520000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000032c0b9bc01ac66';

  group('ABI Decoder', () {
    test('should get function name and signature', () {
      final functionName = EthDataDecoder.paraSwap.getFunctionName(exampleData);
      expect(functionName, expectedFunctionName);

      final functionSignature =
          EthDataDecoder.paraSwap.getFunctionSignature(exampleData);
      expect(functionSignature, expectedFunctionSignature);
    });

    test('should decode function parameters', () {
      // Expected values map for validation
      final expectedValues = {
        'executor': '0x00c600b30fb0400701010f4b080409018b9006e0',
        'swapData': {
          'srcToken': '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee',
          'destToken': '0xc1cba3fcea344f92d9239c08c0568f6f2f0ee452',
          'fromAmount': BigInt.parse('107660000000000000'),
          'toAmount': BigInt.parse('88825355231130069'),
          'quotedAmount': BigInt.parse('89271713800130723'),
          'metadata':
              '0x956759cbb6c74411b8481488f0cf2d6a00000000000000000000000001fe461d',
          'beneficiary': '0x0000000000000000000000000000000000000000',
        },
        'partnerAndFee': BigInt.parse(
            '100472862009825574373237611346929030672192235185884784397446195511462664863744'),
        'permit': '0x',
        'executorData':
            '0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000007e0000000000000000000000000000007800000000000000000000000000000271042000000000000000000000000000000000000060000002000040000ff00000900000000000000000000000000000000000000000000000000000000d0e30db000000000000000000000000000000000000000000000072006c40624000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000001c0000000000000000000000000000020d042000000000000000000000000000000000000060000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb000000000000000000000000744d441ed6a00d59ea1e3fdbad2b10d9a869c92f0000000000000000000000000000000000000000000000000141499b8f79c000744d441ed6a00d59ea1e3fdbad2b10d9a869c92f000001200024000020000003000000000000000000000000000000000000000000000000000000003eece7db0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000141499b8f79c00000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040c00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000004c000000000000001200000000000000640aee2b8d4a154e36f479daece3fb3e6c3c03d396e00000140008400ef0000000b00000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000000000000000000000000000000000006890239e000000000000000000000000000000000000000000000000003d3297890b00000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b42000000000000000000000000000000000000060001f42416092f143378750bb29b79ed961ab195cceea500000000000000000000000000000000000000000085a80afee867adf27b50bdb7b76da70f1e853062000002c001040244ff00000b00000000000000000000000000000000000000000000000000000000286f580d0000000000000000000000000000000000000000000000000000000000000080ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000002416092f143378750bb29b79ed961ab195cceea50000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000003a47db6cf8ebde00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000f8f10f39116716e89498c1c5e94137ada11b2bc7000000000000000000000000f8f10f39116716e89498c1c5e94137ada11b2bc70000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b5bfb5adb736ea852bd58fec71db3b356c2a39380000000000000000000000000830820d1a9aa1554364752d6d8f55c836871b7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000830820d1a9aa1554364752d6d8f55c836871b74000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee45200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee4520000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000032c0b9bc01ac66',
      };

      final result = EthDataDecoder.paraSwap.decodeParameters(exampleData);

      expect(result, isNotNull);
      expect(result!['function'], expectedFunctionName);
      expect(result['signature'], expectedFunctionSignature);

      if (result.containsKey('error')) {
        fail('Decoding failed: ${result['error']}');
      }

      expect(result['parameters'], isA<List>());

      final parameters = result['parameters'] as List;
      expect(parameters.length, 5);

      // Validate executor parameter
      expect(parameters[0]['name'], 'executor');
      expect(parameters[0]['type'], 'address');
      expect(parameters[0]['value'], isA<String>());
      expect((parameters[0]['value'] as String).startsWith('0x'), true);
      expect(parameters[0]['value'], expectedValues['executor']);

      // Validate swapData tuple parameter
      expect(parameters[1]['name'], 'swapData');
      expect(parameters[1]['type'], 'tuple');
      expect(parameters[1]['value'], isA<List>());

      final tupleData = parameters[1]['value'] as List;
      expect(tupleData.length, 7);
      final expectedSwapData =
          expectedValues['swapData'] as Map<String, dynamic>;

      // Validate tuple fields contain type and name information
      expect(tupleData[0]['name'], 'srcToken');
      expect(tupleData[0]['type'], 'address');
      expect(tupleData[0]['value'], isA<String>());
      expect(tupleData[0]['value'], expectedSwapData['srcToken']);

      expect(tupleData[1]['name'], 'destToken');
      expect(tupleData[1]['type'], 'address');
      expect(tupleData[1]['value'], isA<String>());
      expect(tupleData[1]['value'], expectedSwapData['destToken']);

      expect(tupleData[2]['name'], 'fromAmount');
      expect(tupleData[2]['type'], 'uint256');
      expect(tupleData[2]['value'], isA<BigInt>());
      expect(tupleData[2]['value'], expectedSwapData['fromAmount']);

      expect(tupleData[3]['name'], 'toAmount');
      expect(tupleData[3]['type'], 'uint256');
      expect(tupleData[3]['value'], isA<BigInt>());
      expect(tupleData[3]['value'], expectedSwapData['toAmount']);

      expect(tupleData[4]['name'], 'quotedAmount');
      expect(tupleData[4]['type'], 'uint256');
      expect(tupleData[4]['value'], isA<BigInt>());
      expect(tupleData[4]['value'], expectedSwapData['quotedAmount']);

      expect(tupleData[5]['name'], 'metadata');
      expect(tupleData[5]['type'], 'bytes32');
      expect(tupleData[5]['value'], isA<String>());
      expect(tupleData[5]['value'], expectedSwapData['metadata']);

      expect(tupleData[6]['name'], 'beneficiary');
      expect(tupleData[6]['type'], 'address');
      expect(tupleData[6]['value'], isA<String>());
      expect(tupleData[6]['value'], expectedSwapData['beneficiary']);

      // Validate partnerAndFee parameter
      expect(parameters[2]['name'], 'partnerAndFee');
      expect(parameters[2]['type'], 'uint256');
      expect(parameters[2]['value'], isA<BigInt>());
      expect(parameters[2]['value'], expectedValues['partnerAndFee']);

      // Validate permit parameter
      expect(parameters[3]['name'], 'permit');
      expect(parameters[3]['type'], 'bytes');
      expect(parameters[3]['value'], isA<String>());
      expect(parameters[3]['value'], expectedValues['permit']);

      // Validate executorData parameter
      expect(parameters[4]['name'], 'executorData');
      expect(parameters[4]['type'], 'bytes');
      expect(parameters[4]['value'], isA<String>());
      expect(parameters[4]['value'], expectedValues['executorData']);
    });
  });
}
