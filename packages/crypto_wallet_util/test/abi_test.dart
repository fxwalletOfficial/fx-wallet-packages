import 'package:test/test.dart';

import 'package:crypto_wallet_util/crypto_utils.dart';

void main() {
  final expectedFunctionName = 'swapExactAmountIn';
  final expectedFunctionSignature =
      'swapExactAmountIn(address,(address,address,uint256,uint256,uint256,bytes32,address),uint256,bytes,bytes)';

  const exampleData =
      '0xe3ead59e00000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee452000000000000000000000000000000000000000000000000017e7c331884c000000000000000000000000000000000000000000000000000013b9230a19971d5000000000000000000000000000000000000000000000000013d2826958c10a3956759cbb6c74411b8481488f0cf2d6a00000000000000000000000001fe461d0000000000000000000000000000000000000000000000000000000000000000de219fe970acbc88c63c9c4d0705837c6701495f90000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000007e0000000000000000000000000000007800000000000000000000000000000271042000000000000000000000000000000000000060000002000040000ff00000900000000000000000000000000000000000000000000000000000000d0e30db000000000000000000000000000000000000000000000072006c40624000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000001c0000000000000000000000000000020d042000000000000000000000000000000000000060000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb000000000000000000000000744d441ed6a00d59ea1e3fdbad2b10d9a869c92f0000000000000000000000000000000000000000000000000141499b8f79c000744d441ed6a00d59ea1e3fdbad2b10d9a869c92f000001200024000020000003000000000000000000000000000000000000000000000000000000003eece7db0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000141499b8f79c00000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040c00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000004c000000000000001200000000000000640aee2b8d4a154e36f479daece3fb3e6c3c03d396e00000140008400ef0000000b00000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000000000000000000000000000000000006890239e000000000000000000000000000000000000000000000000003d3297890b00000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b42000000000000000000000000000000000000060001f42416092f143378750bb29b79ed961ab195cceea500000000000000000000000000000000000000000085a80afee867adf27b50bdb7b76da70f1e853062000002c001040244ff00000b00000000000000000000000000000000000000000000000000000000286f580d0000000000000000000000000000000000000000000000000000000000000080ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000002416092f143378750bb29b79ed961ab195cceea50000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000003a47db6cf8ebde00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000f8f10f39116716e89498c1c5e94137ada11b2bc7000000000000000000000000f8f10f39116716e89498c1c5e94137ada11b2bc70000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b5bfb5adb736ea852bd58fec71db3b356c2a39380000000000000000000000000830820d1a9aa1554364752d6d8f55c836871b7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000830820d1a9aa1554364752d6d8f55c836871b74000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee45200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee4520000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000032c0b9bc01ac66';

  group('ABI Decoder', () {
    test('should get function name and signature', () {
      final functionName = EthDataDecoder.paraSwap.getFunctionName(exampleData);
      expect(functionName, expectedFunctionName);

      final functionSignature =
          EthDataDecoder.paraSwap.getFunctionSignature(exampleData);
      expect(functionSignature, expectedFunctionSignature);

      final functions = EthDataDecoder.paraSwap.functions;
      final signature = EthDataDecoder.paraSwap.signatures;
      expect(functions, isNotEmpty);
      expect(signature, isNotEmpty);
      assert(EthDataDecoder.paraSwap.hasFunction(exampleData.substring(0, 10)));
      final selector = AbiDecoder.compute4BytesSignature(functionSignature!);
      expect(selector, exampleData.substring(0, 10));
    });

    test('should decode function parameters', () {
      // Expected values map for validation
      final expectedValues = {
        'executor': '0x00c600b30fb0400701010f4b080409018b9006e0',
        'swapData': {
          'srcToken': '0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee',
          'destToken': '0xc1cba3fcea344f92d9239c08c0568f6f2f0ee452',
          'fromAmount': BigInt.parse('107660000000000000'),
          'toAmount': BigInt.parse('88825355231130069'),
          'quotedAmount': BigInt.parse('89271713800130723'),
          'metadata':
              '0x956759cbb6c74411b8481488f0cf2d6a00000000000000000000000001fe461d',
          'beneficiary': '0x0000000000000000000000000000000000000000',
        },
        'partnerAndFee': BigInt.parse(
            '100472862009825574373237611346929030672192235185884784397446195511462664863744'),
        'permit': '0x',
        'executorData':
            '0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000007e0000000000000000000000000000007800000000000000000000000000000271042000000000000000000000000000000000000060000002000040000ff00000900000000000000000000000000000000000000000000000000000000d0e30db000000000000000000000000000000000000000000000072006c40624000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000001c0000000000000000000000000000020d042000000000000000000000000000000000000060000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb000000000000000000000000744d441ed6a00d59ea1e3fdbad2b10d9a869c92f0000000000000000000000000000000000000000000000000141499b8f79c000744d441ed6a00d59ea1e3fdbad2b10d9a869c92f000001200024000020000003000000000000000000000000000000000000000000000000000000003eece7db0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000141499b8f79c00000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040c00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000004c000000000000001200000000000000640aee2b8d4a154e36f479daece3fb3e6c3c03d396e00000140008400ef0000000b00000000000000000000000000000000000000000000000000000000c04b8d59000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000c600b30fb0400701010f4b080409018b9006e0000000000000000000000000000000000000000000000000000000006890239e000000000000000000000000000000000000000000000000003d3297890b00000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002b42000000000000000000000000000000000000060001f42416092f143378750bb29b79ed961ab195cceea500000000000000000000000000000000000000000085a80afee867adf27b50bdb7b76da70f1e853062000002c001040244ff00000b00000000000000000000000000000000000000000000000000000000286f580d0000000000000000000000000000000000000000000000000000000000000080ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000002416092f143378750bb29b79ed961ab195cceea50000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000003a47db6cf8ebde00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000f8f10f39116716e89498c1c5e94137ada11b2bc7000000000000000000000000f8f10f39116716e89498c1c5e94137ada11b2bc70000000000000000000000000000000000000000000000000000000000000001000000000000000000000000b5bfb5adb736ea852bd58fec71db3b356c2a39380000000000000000000000000830820d1a9aa1554364752d6d8f55c836871b7400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000830820d1a9aa1554364752d6d8f55c836871b74000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee45200000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000c1cba3fcea344f92d9239c08c0568f6f2f0ee4520000006000240000ff00000300000000000000000000000000000000000000000000000000000000a9059cbb0000000000000000000000006a000f20005980200259b80c51020030400010680000000000000000000000000000000000000000000000000032c0b9bc01ac66',
      };

      final result = EthDataDecoder.paraSwap.decodeParameters(exampleData);

      expect(result, isNotNull);
      expect(result!['function'], expectedFunctionName);
      expect(result['signature'], expectedFunctionSignature);

      if (result.containsKey('error')) {
        fail('Decoding failed: ${result['error']}');
      }

      final parameters = result['parameters'] as List;
      final formattedParams = EthDataDecoder.formatParameters(parameters);

      // Verify that the formatted parameter structure matches the expected values
      expect(formattedParams, equals(expectedValues));
    });

    test('should decode cowswap function parameters', () {
      final expectedFunctionName = 'createOrder';
      final expectedFunctionSignature =
          'createOrder((address,address,uint256,uint256,bytes32,uint256,uint32,bool,int64))';

      final result = EthDataDecoder.cowSwap.decodeParameters(
          '0x322bba21000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec7000000000000000000000000fe41c979893d29dcb36b2bf9fa01d7168f038c4a000000000000000000000000000000000000000000000000000908d853a9f00000000000000000000000000000000000000000000000000000000000006528a857dd2c0a3c123dac2cd675953bef259a1470eb5d31f8a2f5f3221641591f2ead00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000068d6695400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038f81837');
      expect(result, isNotNull);
      expect(result!['function'], expectedFunctionName);
      expect(result['signature'], expectedFunctionSignature);
    });
  });

  test('should decode function parameters', () {
    const abi = [
      {
        "inputs": [
          {"internalType": "address", "name": "spender", "type": "address"},
          {"internalType": "uint256", "name": "amount", "type": "uint256"}
        ],
        "name": "approve",
        "outputs": [
          {"internalType": "bool", "name": "", "type": "bool"}
        ],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];
    const data =
        '0x095ea7b300000000000000000000000068d6b739d2020067d1e2f713b999da97e4d548120000000000000000000000000000000000000000000000000000000005f5e100';
    final result = EthDataDecoder.decodeByAbi(abi, data);
    expect(result['function'], "approve");
  });

  group('bridge abi', () {
    test('should decode arbitrum bridge data', () {
      const l2Data =
          '0x25e1606300000000000000000000000005cdb1526f6e224e02919a4c018d9784ea25eb3d';
      final l2Result = EthDataDecoder.arbitrumBridge.decodeParameters(l2Data);
      expect(l2Result?['function'], 'withdrawEth');
      const l1DataDeposit = "0x439370b1";
      const l1DataRetryable =
          '0x679b6ded000000000000000000000000c018b9a9a1e881c0be9078c580e7b10041e33230000000000000000000000000000000000000000000000000ebec21ee1da400000000000000000000000000000000000000000000000000000000002a12fd0f20000000000000000000000000c018b9a9a1e881c0be9078c580e7b10041e33230000000000000000000000000c018b9a9a1e881c0be9078c580e7b10041e332300000000000000000000000000000000000000000000000000000000000006b77000000000000000000000000000000000000000000000000000000000393870000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000';
      final l1DataDepositResult =
          EthDataDecoder.arbitrumBridge.decodeParameters(l1DataDeposit);
      expect(l1DataDepositResult?['function'], 'depositEth');
      final l1DataRetryableResult =
          EthDataDecoder.arbitrumBridge.decodeParameters(l1DataRetryable);
      expect(l1DataRetryableResult?['function'], 'createRetryableTicket');
    });

    test('should decode relay bridge data', () {
      const depositErc20Data =
          '0xe801795200000000000000000000000023ab32843d51fd619464d5d4216d27f2b37e9110000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e583100000000000000000000000000000000000000000000000000000000009bad552c9183e7d0c75dcf59889134f964712aa494e636903bd179919d196948546b57';
      final depositErc20Result =
          EthDataDecoder.relayBridge.decodeParameters(depositErc20Data);
      expect(depositErc20Result?['function'], 'depositErc20');

      const depositNativeData =
          '0x49290c1c00000000000000000000000023ab32843d51fd619464d5d4216d27f2b37e9110d68124426237121afbf4f09a89b3497acf6a13f3348ae87e25ee464aefa765c0';
      final depositNativeResult =
          EthDataDecoder.relayBridge.decodeParameters(depositNativeData);
      expect(depositNativeResult?['function'], 'depositNative');
    });

    test('should decode meson bridge data', () {
      const data =
          '0x264849e7010001c6b640d80000000000070a9bd0000000000000695263e102ca22232902';
      final result = EthDataDecoder.mesonBridge.decodeParameters(data);
      expect(result?['function'], 'simpleExecuteSwap');
    });

    test('should decode across bridge data', () {
      const data =
          '0xad5425c600000000000000000000000023ab32843d51fd619464d5d4216d27f2b37e911000000000000000000000000023ab32843d51fd619464d5d4216d27f2b37e9110000000000000000000000000af88d065e77c8cc2239327c5edb3a432268e5831000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000000000000000f55c800000000000000000000000000000000000000000000000000000000000f48200000000000000000000000000000000000000000000000000000000000002105000000000000000000000000ef1ec136931ab5728b0783fd87d109c9d15d31f10000000000000000000000000000000000000000000000000000000069524e1f0000000000000000000000000000000000000000000000000000000069526a3f0000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000000001dc0de007f73c0de';
      final result = EthDataDecoder.acrossBridge.decodeParameters(data);
      expect(result?['function'], 'deposit');
    });

    test('should decode cctp bridge data', () {
      const burnData =
          "0x8e0250ee0000000000000000000000000000000000000000000000000000000000030d400000000000000000000000000000000000000000000000000000000000000006000000000000000000000000565d4ba385fc4e3c1b07ce078682c84719475e7600000000000000000000000075faf114eafb1bdbe2f0316df893fd58ce46aa4d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030d3f00000000000000000000000000000000000000000000000000000000000003e8";
      final burnResult = EthDataDecoder.cctpBridge.decodeParameters(burnData);
      expect(burnResult?['function'], 'depositForBurn');
      const receiveData = "0x57ecfd28000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000017800000001000000030000000644e7740372f570c856599ac4db6211c05249607c86e7c0b084b07bb0b066077a0000000000000000000000008fe6b999dc680ccfdd5bf7eb0974218be2542daa0000000000000000000000008fe6b999dc680ccfdd5bf7eb0974218be2542daa0000000000000000000000000000000000000000000000000000000000000000000007d0000007d00000000100000000000000000000000075faf114eafb1bdbe2f0316df893fd58ce46aa4d000000000000000000000000565d4ba385fc4e3c1b07ce078682c84719475e76000000000000000000000000000000000000000000000000000000000007a120000000000000000000000000565d4ba385fc4e3c1b07ce078682c84719475e76000000000000000000000000000000000000000000000000000000000000006400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000825c36765ca4146cba1ee4da4e214a467c18c9e8e2dc69ce1a17094a49a0b9ebd84ab102759d2f3f42a61b0d107c0b17f402bfe574936006f28c83c6196465205d1c71e1012bd4c05a7f07d177f7ab9d84fa7925392578784dc04b80aad3e191822303d5e64790f9141227456abec6c90d37df2103fa208f590f97ecf8af26296c311c000000000000000000000000000000000000000000000000000000000000";
      final receiveResult = EthDataDecoder.cctpBridge.decodeParameters(receiveData);
      expect(receiveResult?['function'], 'receiveMessage');
    });
  });
}
